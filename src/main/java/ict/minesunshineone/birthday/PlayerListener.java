package ict.minesunshineone.birthday;

import java.io.File;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;

import org.bukkit.Material;
import org.bukkit.Sound;
import org.bukkit.configuration.file.YamlConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.inventory.ItemStack;

import io.papermc.paper.event.player.AsyncChatEvent;
import net.kyori.adventure.text.Component;
import net.kyori.adventure.text.format.NamedTextColor;
import net.kyori.adventure.text.serializer.plain.PlainTextComponentSerializer;

public class PlayerListener implements Listener {

    private final BirthdayPlugin plugin;
    private final BirthdayGUI birthdayGUI;

    public PlayerListener(BirthdayPlugin plugin) {
        this.plugin = plugin;
        this.birthdayGUI = new BirthdayGUI(plugin);
    }

    @EventHandler
    public void onPlayerJoin(PlayerJoinEvent event) {
        Player player = event.getPlayer();
        String uuid = player.getUniqueId().toString();

        plugin.getServer().getRegionScheduler().runDelayed(plugin, player.getLocation(), (task) -> {
            if (plugin.getPlayerDataManager().getBirthday(uuid) == null) {
                // Ê£ÄÊü•Áé©ÂÆ∂ÊòØÂê¶Â∑≤ÁªèÁúãËøáGUIÊèêÁ§∫
                boolean hasSeenGUI = plugin.getPlayerDataManager().hasSeenBirthdayGUI(uuid);
                
                if (!hasSeenGUI) {
                    // Á¨¨‰∏ÄÊ¨°ËøõÊúçÂä°Âô® - ÂºπÂá∫GUI + ÊòéÊòæÊèêÁ§∫
                    birthdayGUI.openBirthdayGUI(player);
                    
                    // ÂèëÈÄÅÈÜíÁõÆÁöÑÊ¨¢ËøéÊ∂àÊÅØ
                    player.sendMessage(Component.empty());
                    player.sendMessage(Component.text("üéâüéÇüéâüéÇüéâüéÇüéâüéÇüéâüéÇüéâüéÇüéâüéÇüéâ")
                            .color(NamedTextColor.GOLD));
                    player.sendMessage(Component.text("          ‚ú® Ê¨¢ËøéÊù•Âà∞ÊúçÂä°Âô®ÔºÅ‚ú®")
                            .color(NamedTextColor.AQUA).decorate(net.kyori.adventure.text.format.TextDecoration.BOLD));
                    player.sendMessage(Component.text("üéâüéÇüéâüéÇüéâüéÇüéâüéÇüéâüéÇüéâüéÇüéâüéÇüéâ")
                            .color(NamedTextColor.GOLD));
                    player.sendMessage(Component.empty());
                    
                    player.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ÁîüÊó•Á≥ªÁªü ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
                            .color(NamedTextColor.GOLD));
                    player.sendMessage(Component.text("üéà ËØ∑ËÆæÁΩÆ‰Ω†ÁöÑÁîüÊó•‰ø°ÊÅØÔºÅüéà")
                            .color(NamedTextColor.YELLOW).decorate(net.kyori.adventure.text.format.TextDecoration.BOLD));
                    player.sendMessage(Component.text("ÁîüÊó•ÂΩìÂ§©‰ºöÊúâÁâπÊÆäÁöÑÂ∫ÜÁ•ùÊ¥ªÂä®Âì¶ÔºÅ")
                            .color(NamedTextColor.GREEN));
                    player.sendMessage(Component.text("ËØ∑Âú®ÂºπÂá∫ÁöÑÁïåÈù¢‰∏≠ÈÄâÊã©‰Ω†ÁöÑÁîüÊó•Êúà‰ªΩÂíåÊó•Êúü")
                            .color(NamedTextColor.YELLOW));
                    player.sendMessage(Component.text("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
                            .color(NamedTextColor.GOLD));
                    player.sendMessage(Component.empty());
                    
                    // Êí≠ÊîæÊèêÁ§∫Èü≥Êïà
                    player.playSound(player.getLocation(), Sound.ENTITY_EXPERIENCE_ORB_PICKUP, 1.0f, 1.0f);
                    
                    // Ê†áËÆ∞Áé©ÂÆ∂Â∑≤ÁªèÁúãËøáGUI
                    plugin.getPlayerDataManager().setHasSeenBirthdayGUI(uuid, true);
                } else {
                    // Á¨¨‰∫åÊ¨°Âèä‰ª•Âêé - Âè™ÊòæÁ§∫Â∑¶‰∏ãËßíÊèêÁ§∫
                    sendBirthdayReminder(player);
                }
            } else {
                Calendar today = Calendar.getInstance();
                int currentMonth = today.get(Calendar.MONTH) + 1;
                int currentDay = today.get(Calendar.DAY_OF_MONTH);
                int currentYear = today.get(Calendar.YEAR);
                String todayString = currentMonth + "-" + currentDay;
                String currentYearString = String.valueOf(currentYear);

                YamlConfiguration playerData = plugin.getPlayerDataManager().getPlayerData(uuid);
                String birthdayString = playerData.getString("birthday");

                if (birthdayString != null && birthdayString.equals(todayString)) {
                    // Ê£ÄÊü•Áé©ÂÆ∂ÂΩìÂπ¥ÊòØÂê¶Â∑≤ÁªèÂ∫ÜÁ•ùËøáÁîüÊó•
                    if (!plugin.getPlayerDataManager().hasCelebratedThisYear(uuid, currentYearString)) {
                        plugin.celebrateBirthday(player);
                        // ËÆ∞ÂΩïÂ∫ÜÁ•ùÂπ¥‰ªΩËÄå‰∏çÊòØÂÖ∑‰ΩìÊó•Êúü
                        plugin.getPlayerDataManager().setLastCelebratedYear(uuid, currentYearString);
                        // ‰øùÁïôÂéüÊúâÁöÑlast_celebratedÂ≠óÊÆµ‰ª•ÂÖºÂÆπÂÖ∂‰ªñÂäüËÉΩ
                        plugin.getPlayerDataManager().setLastCelebrated(uuid, todayString);
                    }
                }
            }
        }, 20L);
    }

    @EventHandler
    public void onInventoryClick(InventoryClickEvent event) {
        String title = PlainTextComponentSerializer.plainText().serialize(event.getView().title());
        Player player = (Player) event.getWhoClicked();

        // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰øÆÊîπ‰ªñ‰∫∫ÁîüÊó•
        if (title.startsWith("‰øÆÊîπ ") && !player.hasPermission("birthday.modify")) {
            event.setCancelled(true);
            player.closeInventory();
            player.sendMessage(Component.text("‰Ω†Ê≤°ÊúâÊùÉÈôê‰øÆÊîπÂÖ∂‰ªñÁé©ÂÆ∂ÁöÑÁîüÊó•ÔºÅ").color(NamedTextColor.RED));
            return;
        }

        if (title.equals("ËØ∑ÈÄâÊã©‰Ω†ÁöÑÁîüÊó•Êúà‰ªΩ")) {
            event.setCancelled(true);
            ItemStack clickedItem = event.getCurrentItem();
            if (clickedItem != null && clickedItem.getType() == Material.PAPER) {
                // ËÆ°ÁÆóÂÆûÈôÖÊúà‰ªΩ
                int slot = event.getSlot();
                int row = (slot - 10) / 9;
                int col = (slot - 10) % 9;
                int month;
                if (row == 0) {
                    month = col + 1;
                } else {
                    month = (row * 6) + (col - 1) + 1; // Âáè1ÊòØÂõ†‰∏∫Á¨¨‰∫åË°åÂêëÂè≥ÁßªÂä®‰∫Ü‰∏ÄÂàó
                }

                if (month >= 1 && month <= 12) {
                    birthdayGUI.openDayGUI((Player) event.getWhoClicked(), month);
                }
            }
        } else if (title.equals("ËØ∑ÈÄâÊã©Êó•Êúü")) {
            event.setCancelled(true);
            ItemStack clickedItem = event.getCurrentItem();
            if (clickedItem != null && clickedItem.getType() == Material.PAPER) {
                // ËÆ°ÁÆóÂÆûÈôÖÊó•Êúü
                int slot = event.getSlot();
                int row = (slot - 10) / 9;
                int col = (slot - 10) % 9;
                int day = row * 7 + col + 1;

                int selectedMonth = birthdayGUI.getSelectedMonth(player);
                if (day >= 1 && day <= birthdayGUI.getDaysInMonth(selectedMonth)) {
                    birthdayGUI.saveBirthday(player, selectedMonth, day);
                    player.closeInventory();
                }
            }
        }
    }

    @EventHandler(priority = EventPriority.NORMAL)
    public void onPlayerChat(AsyncChatEvent event) {
        Component message = event.message();
        if (PlainTextComponentSerializer.plainText().serialize(message).equals("ÁîüÊó•Âø´‰πê")) {
            plugin.getServer().getRegionScheduler().execute(plugin, event.getPlayer().getLocation(), () -> {
                checkBirthdayWish(event.getPlayer());
            });
        }
    }

    private void checkBirthdayWish(Player sender) {
        Calendar today = Calendar.getInstance();
        int currentMonth = today.get(Calendar.MONTH) + 1;
        int currentDay = today.get(Calendar.DAY_OF_MONTH);
        String todayString = currentMonth + "-" + currentDay;

        File playerDataFolder = new File(plugin.getDataFolder(), "player_data");
        File[] playerFiles = playerDataFolder.listFiles((dir, name) -> name.endsWith(".yml"));

        List<String> birthdayPlayers = new ArrayList<>();

        if (playerFiles != null) {
            for (File file : playerFiles) {
                String uuid = file.getName().replace(".yml", "");
                YamlConfiguration playerData = plugin.getPlayerDataManager().getPlayerData(uuid);
                String birthdayString = playerData.getString("birthday");

                if (birthdayString != null && birthdayString.equals(todayString)) {
                    String playerName = playerData.getString("name");
                    if (playerName != null) {
                        birthdayPlayers.add(playerName);
                    }
                }
            }
        }

        if (!birthdayPlayers.isEmpty()) {
            handleBirthdayWish(sender, birthdayPlayers, todayString);
        } else {
            sender.sendMessage(Component.text("‰ªäÂ§©Ê≤°Êúâ‰∫∫ËøáÁîüÊó•Âì¶ÔºÅ")
                    .color(NamedTextColor.RED));
        }
    }

    private void handleBirthdayWish(Player sender, List<String> birthdayPlayers, String todayString) {
        String uuid = sender.getUniqueId().toString();
        YamlConfiguration wishData = plugin.getPlayerDataManager().getPlayerData(uuid);
        String wishKey = "wishes." + todayString;
        List<String> todayWishes = wishData.getStringList(wishKey);

        if (!todayWishes.contains(uuid)) {
            plugin.getServer().getRegionScheduler().execute(plugin, sender.getLocation(), () -> {
                ItemStack cake = new ItemStack(Material.CAKE, 1);
                sender.getInventory().addItem(cake);

                String playersString = String.join("„ÄÅ", birthdayPlayers);
                sender.sendMessage(Component.text("‰ªäÂ§©ËøáÁîüÊó•ÁöÑÁé©ÂÆ∂Ôºö")
                        .color(NamedTextColor.GOLD)
                        .append(Component.text(playersString)
                                .color(NamedTextColor.YELLOW)));
                sender.sendMessage(Component.text("ÊÑüË∞¢‰Ω†ÈÄÅ‰∏äÁîüÊó•Á•ùÁ¶èÔºÅ")
                        .color(NamedTextColor.GREEN));
            });

            todayWishes.add(uuid);
            wishData.set(wishKey, todayWishes);
            plugin.getPlayerDataManager().savePlayerData(uuid, wishData);
        } else {
            String message = plugin.getConfig().getString("messages.wish-already", "‰Ω†‰ªäÂ§©Â∑≤ÁªèÈÄÅËøáÁîüÊó•Á•ùÁ¶è‰∫ÜÔºÅ");
            sender.sendMessage(Component.text(message != null ? message : "‰Ω†‰ªäÂ§©Â∑≤ÁªèÈÄÅËøáÁîüÊó•Á•ùÁ¶è‰∫ÜÔºÅ")
                    .color(NamedTextColor.YELLOW));
        }
    }

    // ÂèëÈÄÅÁîüÊó•ÊèêÈÜíÊ∂àÊÅØÔºàÂ∑¶‰∏ãËßíÊèêÁ§∫Ôºâ
    private void sendBirthdayReminder(Player player) {
        // ‰ΩøÁî®ActionBarÂèëÈÄÅÂ∫ïÈÉ®ÊèêÁ§∫
        player.sendActionBar(Component.text("üí° ÊèêÁ§∫Ôºö‰Ω†ËøòÊ≤°ÊúâËÆæÁΩÆÁîüÊó•ÔºÅ‰ΩøÁî® /birthday set ËøõË°åËÆæÁΩÆ")
                .color(NamedTextColor.GOLD));
        
        // ÂêåÊó∂ÂèëÈÄÅËÅäÂ§©ÊèêÁ§∫Ôºå‰ΩÜÊØîËæÉÁÆÄÊ¥Å
        player.sendMessage(Component.text("üéÇ ‰Ω†ËøòÊ≤°ÊúâËÆæÁΩÆÁîüÊó•‰ø°ÊÅØÔºå‰ΩøÁî® /birthday set ÂëΩ‰ª§ËÆæÁΩÆÂêßÔºÅ")
                .color(NamedTextColor.YELLOW));
        
        // ËΩªÂæÆÁöÑÊèêÁ§∫Èü≥
        player.playSound(player.getLocation(), Sound.BLOCK_NOTE_BLOCK_CHIME, 0.5f, 1.0f);
    }
}
